env:
  # å¯é€‰å€¼ï¼Œå¯æ‰‹åŠ¨è§¦å‘è¾“å…¥ patch/minor/major æ§åˆ¶ç‰ˆæœ¬
  VERSION_BUMP: ${{ github.event.inputs.version_bump || 'patch' }} 

on:
  push:
    branches:
      - main
      - 'feature-*'
      - 'feat-*'
    tags:
      - 'v*'
  
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump level"
        required: false
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç ä»“åº“
      - uses: actions/checkout@v3

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org/'

      # ç¼“å­˜ Yarn ä¾èµ–
      - name: Cache Yarn
        uses: actions/cache@v3
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: yarn-${{ runner.os }}-${{ hashFiles('yarn.lock') }}

      # æ£€æŸ¥ Node.js ç‰ˆæœ¬
      - name: Check Node version
        run: node --version

      # æ£€æŸ¥ Yarn ç‰ˆæœ¬
      - name: Check Yarn version
        run: yarn --version

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: yarn install --immutable

      # æ„å»ºé¡¹ç›®
      - name: Build project
        run: yarn build

      # å¤„ç†ç‰ˆæœ¬å·å’Œæ ‡ç­¾
      - name: Determine version
        id: version
        run: |
          # å¦‚æœå½“å‰è§¦å‘çš„æ˜¯ä¸€ä¸ªå¸¦æœ‰ç‰ˆæœ¬å·çš„ Git æ ‡ç­¾
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·
            VERSION="${GITHUB_REF#refs/tags/v}"
            # è®¾ç½® npm å‘å¸ƒçš„æ ‡ç­¾ä¸º "latest"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "npm_tag=latest" >> $GITHUB_OUTPUT
            # æ ‡è®°ä¸ºå·²æ‰“æ ‡ç­¾çš„ç‰ˆæœ¬
            echo "tagged=true" >> $GITHUB_OUTPUT
          else
            # è·å–å½“å‰ npm ä¸Šå·²å‘å¸ƒçš„æ‰€æœ‰ç‰ˆæœ¬
            VERSIONS=$(npm view @officesdk/rpc versions --json || echo "[]")
            echo "ğŸ“¦ existing versions: $VERSIONS"
            # æ‰¾åˆ°æœ€æ–°çš„ç‰ˆæœ¬å·
            LATEST_VERSION=$(echo "$VERSIONS" | jq -r '.[]' | sort -rV | head -n1)
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç‰ˆæœ¬ï¼Œé»˜è®¤ä» "0.0.0" å¼€å§‹
            if [[ -z "$LATEST_VERSION" ]]; then
              LATEST_VERSION="0.0.0"
            fi

            # å¦‚æœå½“å‰åˆ†æ”¯æ˜¯ mainï¼Œåˆ™ä½¿ç”¨ beta æ ‡ç­¾ï¼Œå¦åˆ™ä½¿ç”¨ alpha æ ‡ç­¾
            if [[ "$GITHUB_REF" == refs/heads/main ]]; then
              PRE_TAG="beta"
            else
              PRE_TAG="alpha"
            fi

            # å¦‚æœæœ€æ–°ç‰ˆæœ¬å·²ç»æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆå¸¦æœ‰ alpha æˆ– beta æ ‡ç­¾ï¼‰
            if [[ "$LATEST_VERSION" == *"-${PRE_TAG}."* ]]; then
              # æå–åŸºç¡€ç‰ˆæœ¬å·å’Œå½“å‰é¢„å‘å¸ƒç‰ˆæœ¬å·
              BASE_VERSION=$(echo "$LATEST_VERSION" | sed -E "s/-${PRE_TAG}\.[0-9]+$//")
              LATEST_NUM=$(echo "$LATEST_VERSION" | sed -E "s/.*-${PRE_TAG}\.([0-9]+)$/\1/")
              # å¢åŠ é¢„å‘å¸ƒç‰ˆæœ¬å·
              NEXT_NUM=$((LATEST_NUM + 1))
              VERSION="${BASE_VERSION}-${PRE_TAG}.${NEXT_NUM}"
            else
              # å¦‚æœä¸æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œåˆ™æ ¹æ® VERSION_BUMP å†³å®šå¦‚ä½•æ›´æ–°ç‰ˆæœ¬å·
              MAJOR=$(echo "$LATEST_VERSION" | cut -d. -f1)
              MINOR=$(echo "$LATEST_VERSION" | cut -d. -f2)
              PATCH=$(echo "$LATEST_VERSION" | cut -d. -f3)

              case "${VERSION_BUMP}" in
                major)
                  # å¢åŠ ä¸»ç‰ˆæœ¬å·ï¼Œæ¬¡ç‰ˆæœ¬å·å’Œè¡¥ä¸å·å½’é›¶
                  MAJOR=$((MAJOR + 1))
                  MINOR=0
                  PATCH=0
                  ;;
                minor)
                  # å¢åŠ æ¬¡ç‰ˆæœ¬å·ï¼Œè¡¥ä¸å·å½’é›¶
                  MINOR=$((MINOR + 1))
                  PATCH=0
                  ;;
                patch|*)
                  # å¢åŠ è¡¥ä¸å·
                  PATCH=$((PATCH + 1))
                  ;;
              esac

              # ç”Ÿæˆæ–°çš„é¢„å‘å¸ƒç‰ˆæœ¬å·
              VERSION="${MAJOR}.${MINOR}.${PATCH}-${PRE_TAG}.0"
            fi

            # è¾“å‡ºç‰ˆæœ¬å·å’Œ npm æ ‡ç­¾
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "npm_tag=$PRE_TAG" >> $GITHUB_OUTPUT
            # æ ‡è®°ä¸ºæœªæ‰“æ ‡ç­¾çš„ç‰ˆæœ¬
            echo "tagged=false" >> $GITHUB_OUTPUT
          fi

      # æ›´æ–° package.json æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
      - name: Bump package versions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ”§ Updating version to $VERSION"

          jq --arg v "$VERSION" '.version = $v' dist/rpc/package.json > tmp.rpc.json && mv tmp.rpc.json dist/rpc/package.json
          jq --arg v "$VERSION" '.version = $v | .dependencies["@officesdk/rpc"] = $v' dist/web/package.json > tmp.web.json && mv tmp.web.json dist/web/package.json

      # æäº¤ç‰ˆæœ¬å˜æ›´åˆ° Git ä»“åº“
      - name: Commit bumped versions
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f dist/rpc/package.json dist/web/package.json
          git commit -m "chore(release): bump version to ${{ steps.version.outputs.version }} [skip ci]"
          git push

      # å¦‚æœæ˜¯ç¨³å®šç‰ˆæœ¬ï¼Œåˆ›å»º Git æ ‡ç­¾
      - name: Tag release (for stable only)
        if: steps.version.outputs.tagged == 'true'
        run: |
          git tag v${{ steps.version.outputs.version }}
          git push origin v${{ steps.version.outputs.version }}

      # å‘å¸ƒ RPC åŒ…åˆ° npm
      - name: Publish RPC Package
        run: |
          cd dist/rpc
          npm publish --tag ${{ steps.version.outputs.npm_tag }} --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # å‘å¸ƒ WEB åŒ…åˆ° npm
      - name: Publish WEB Package
        run: |
          cd dist/web
          npm publish --tag ${{ steps.version.outputs.npm_tag }} --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # æ„å»ºæˆåŠŸåå‘é€é€šçŸ¥
      - name: Notify on success
        if: success()
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TIMESTAMP=$(($(date +%s%N)/1000000))
          SIGN=$(echo -n "$TIMESTAMP\n${{ secrets.DINGDING_SECRET }}" | openssl dgst -sha256 -hmac "${{ secrets.DINGDING_SECRET }}" -binary | base64)
          ENCODED_SIGN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$SIGN'''))")

          curl -X POST '${{ secrets.DINGDING_WEBHOOK }}&timestamp='"$TIMESTAMP"'&sign='"$ENCODED_SIGN" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "âœ… CI æ„å»ºæˆåŠŸ",
                "text": "### âœ… æ„å»ºå¹¶å‘å¸ƒæˆåŠŸ\n- ç‰ˆæœ¬å·ï¼š'"$VERSION"'\n- ä»“åº“ï¼š[${{ github.repository }}]\n- [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }'

      # æ„å»ºå¤±è´¥åå‘é€é€šçŸ¥
      - name: Notify on failure
        if: failure()
        run: |
          TIMESTAMP=$(($(date +%s%N)/1000000))
          SIGN=$(echo -n "$TIMESTAMP\n${{ secrets.DINGDING_SECRET }}" | openssl dgst -sha256 -hmac "${{ secrets.DINGDING_SECRET }}" -binary | base64)
          ENCODED_SIGN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$SIGN'''))")

          curl -X POST '${{ secrets.DINGDING_WEBHOOK }}&timestamp='"$TIMESTAMP"'&sign='"$ENCODED_SIGN" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "âŒ CI æ„å»ºå¤±è´¥",
                "text": "### âŒ æ„å»ºå¤±è´¥\n- ä»“åº“ï¼š[${{ github.repository }}]\n- åˆ†æ”¯ï¼š`${{ github.ref_name }}`\n- [æŸ¥çœ‹æ„å»ºæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }'
